<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ucEmu</title>


        <script src="basicType/__cpuAsm.js"></script>
        <script src="basicType/__define.js"></script>
        <script src="basicType/_add.js"></script>
        <script src="basicType/_dec.js"></script>
        <script src="basicType/_divMod.js"></script>
        <script src="basicType/_inc.js"></script>
        <script src="basicType/_mul.js"></script>
        <script src="basicType/_neg.js"></script>
        <script src="basicType/_sub.js"></script>
        <script src="basicType/binAnd.js"></script>
        <script src="basicType/binNot.js"></script>
        <script src="basicType/binOr.js"></script>
        <script src="basicType/binSh.js"></script>
        <script src="basicType/binXnor.js"></script>
        <script src="basicType/binXor.js"></script>
        <script src="basicType/cmpE.js"></script>
        <script src="basicType/cmpGT.js"></script>
        <script src="basicType/cmpGTE.js"></script>
        <script src="basicType/cmpLTE.js"></script>
        <script src="basicType/cmpNE.js"></script>
        <script src="basicType/logicAnd.js"></script>
        <script src="basicType/logicNot.js"></script>
        <script src="basicType/logicOr.js"></script>
        <script src="basicType/logicXnor.js"></script>
        <script src="basicType/logicXor.js"></script>
        
        <script src="drivers/KeyboardDriver.js"></script>
        <script src="drivers/ScreenDriver.js"></script>
        <script src="drivers/TimerDriver.js"></script>
        <script src="services/ascii/AsciiTable.js"></script>
        <script src="services/fonts/Font5x8.js"></script>
        <script src="services/fonts/Font3x5.js"></script>
        <script src="services/fonts/Font3x4TwoInOne.js"></script>
        <script src="services/FrameBufferService.js"></script>
        <script src="services/InterpolationService.js"></script>
        <script src="services/KeyboardService.js"></script>
        <script src="services/RasterizerService.js"></script>

        <!-- ucEmu library files -->
        <script src="ucEmu/devices/KeyboardDevice.js"></script>
        <script src="ucEmu/devices/ScreenDevice.js"></script>
        <script src="ucEmu/devices/TimerDevice.js"></script>
        <script src="ucEmu/ucEmu.js"></script>

        <script>
            'use strict';

            console.log(
                div(32000, 21)
            );

            var timerOne = 0;
            var timerOneMs = 5500;
            var timerTwo = 0;
            var timerTwoMs = 500;
            var sinceStartMsPrev = 0;
            var diffMs;
            var randomChar = '?';
            var text = "";

            function rasterizerDrawTriangle(x1, y1, x2, y2, x3, y3)
            {
                fbSet(x1, y1);
                fbSet(x2, y2);
                fbSet(x3, y3);

                rasterizerDrawLine(x1, y1, x2, y2);
                rasterizerDrawLine(x2, y2, x3, y3);
                rasterizerDrawLine(x3, y3, x1, y1);
            }

            function rasterizerDrawLine(x1, y1, x2, y2)
            {
                var slowPos, fastPos;
                var fast, slow;
                var xMode, e;

                if (x1 == x2) {
                    rasterizerDrawLineV(y1, y2, x1);
                    return;
                }

                if (y1 == y2) {
                    rasterizerDrawLineH(x1, x2, y1);
                    return;
                }

                // TODO: clip line here

                // bresenham line below
                xMode = Math.abs(x2 - x1) >= Math.abs(y2 - y1);
                if ((xMode && x1 > x2) || (!xMode && y1 > y2)) {
                    var tmp;

                    tmp = x1;
                    x1 = x2;
                    x2 = tmp;
                    tmp = y1;
                    y1 = y2;
                    y2 = tmp;
                }
                fast = xMode ? x2 - x1 : y2 - y1;
                slow = xMode ? y2 - y1 : x2 - x1;
                slowPos = xMode ? y1 : x1;
                fastPos = xMode ? x1 : y1;
                xMode ? fbSet(fastPos, slowPos) : fbSet(slowPos, fastPos);
                e = fast >> 2;
                for (var i = 0; i < fast; i++) {
                    fastPos++;
                    e = e - (slow > 0 ? slow : -slow);
                    if (e < 0) {
                        e = e + fast;
                        slowPos = slow > 0 ? slowPos + 1 : slowPos - 1;
                    }
                    xMode ? fbSet(fastPos, slowPos) : fbSet(slowPos, fastPos);
                }
            }

            var fontSize = 0;

            function demo3()
            {
                var lineHeight;

                fbSetColor(7);
                fbClear();

                switch (fontSize) {
                    case 0:
                        lineHeight = 5;
                        break;
                    case 1:
                        lineHeight = 6;
                        break;
                    case 2:
                        lineHeight = 9;
                        break;
                }

                fbSetColor(0);
                rasterizerDrawText(0, 0 * lineHeight, ' !"#$%&\'()*+,-./', fontSize);
                rasterizerDrawText(0, 1 * lineHeight, '0123456789:;<=>?', fontSize);
                rasterizerDrawText(0, 2 * lineHeight, '@ABCDEFGHIJKLMNO', fontSize)
                rasterizerDrawText(0, 3 * lineHeight, 'PQRSTUVWXYZ[\\]^_', fontSize);
                rasterizerDrawText(0, 4 * lineHeight, '`abcdefghjiklmno', fontSize);
                rasterizerDrawText(0, 5 * lineHeight, 'pqrstuvwxyz{|}~ ', fontSize);

                rasterizerDrawText(0, 7 * lineHeight, 'Hello world! The quick brown', fontSize);
                rasterizerDrawText(0, 8 * lineHeight, 'fox jumps over the lazy dog.', fontSize);

                timerOne += diffMs;
                if (timerOne > timerOneMs) {
                    timerOne = timerOne % timerOneMs;
                    fontSize = (fontSize + 1) % 3;
                }
            }

            var shadeTest = "Shade test";
            var shadeCurrent = 0;

            function demo2()
            {
                var t1 = timerOne / timerOneMs;

                fbSetColor(7);
                fbClear();

                var barWidth = Math.floor(fbWidth / FB_COLORS);
                for (var bar = 0; bar < FB_COLORS; bar++) {
                    for (var y = 0; y < round(0.5 * fbHeight); y++) {
                        fbSetColor(bar);
                        rasterizerDrawLineH(
                            bar * barWidth, 
                            (bar + 1) * barWidth - 3, 
                            y + Math.abs(round(sinMul(0.25 * fbHeight, t1)))
                        );
                    }
                }
                fbSetColor(shadeCurrent);
                for (var y = round(0.6 * fbHeight); y < fbHeight - 1; y++) {
                    rasterizerDrawLineH(1, fbWidth - 2, y);
                }

                if (shadeTest !== "") {
                    fbSetColor(0);
                    rasterizerDrawText(round(0.5 * (fbWidth - shadeTest.length * 6) + sinMul(0.5 * fbWidth, t1)), round(0.5 * (fbHeight - 8)), shadeTest);
                }

                timerOne += diffMs;
                if (timerOne > timerOneMs) {
                    shadeTest = "";
                    timerOne = timerOne % timerOneMs;
                    shadeCurrent = (shadeCurrent + 1) % FB_COLORS;
                }
            }

            var trXY = [-1, -1, -1, -1, -1, -1];
            var trXYprev = [-1, -1, -1, -1, -1, -1];
            var header = "triangle test";

            function demo1()
            {
                var t1 = timerOne / timerOneMs;

                fbSetColor(7);
                fbClear();
                fbSetColor(0);
                rasterizerDrawTriangle(
                    round(interpolationLinear([trXYprev[0], trXY[0]], t1)), round(interpolationLinear([trXYprev[1], trXY[1]], t1)),
                    round(interpolationLinear([trXYprev[2], trXY[2]], t1)), round(interpolationLinear([trXYprev[3], trXY[3]], t1)),
                    round(interpolationLinear([trXYprev[4], trXY[4]], t1)), round(interpolationLinear([trXYprev[5], trXY[5]], t1))
                );

                if (header !== "") {
                    rasterizerDrawText(round(0.5 * (fbWidth - header.length * 6) + sinMul(0.5 * fbWidth, t1)), round(0.5 * (fbHeight - 8)), header);
                }

                timerOne += diffMs;
                if (timerOne > timerOneMs) {
                    for (var i = 0; i < 6; i++) {
                        trXYprev[i] = trXY[i];
                        trXY[i] = (i % 2 === 0) ? randomInt(-0.25 * fbWidth, 1.25 * fbWidth) : randomInt(-0.25 * fbHeight, 1.25 * fbHeight)
                    }
                    header = "";

                    timerOne = timerOne % timerOneMs;
                }
            }

            function demo0()
            {
                var t1 = timerOne / timerOneMs;

                if (kbEvents.length) {
                    var event = kbEvents.shift();
                    text += event < 128 ? event : '';
                }

                fbSetColor(7);
                fbClear();
                fbSetColor(0);
                rasterizerDrawRect(
                    round(0.25 * fbWidth + sinMul(0.2 * fbWidth, 0.132 - t1)),
                    round(0.25 * fbHeight + sinMul(0.2 * fbHeight, 0.26 - t1)),
                    round(0.75 * fbWidth + sinMul(0.2 * fbWidth, 0.674 - t1)),
                    round(0.75 * fbHeight + sinMul(0.2 * fbHeight, 0.435 - t1))
                );
                rasterizerDrawText(round(sinMul(0.5 * fbWidth, t1)), 0, "ucEmu lib 2015");
                rasterizerDrawText(round(sinMul(0.1 * fbWidth, t1)), 10, text);

                var state = "";

                for (var i = kbKeyAU; i <= kbKeyACT; i++) {
                    state += kbPressed(i) ? "+" : "-";
                }
                rasterizerDrawText(0, 20, state);
                rasterizerDrawText(0, 30, randomChar);

                timerOne += diffMs;
                if (timerOne > timerOneMs) {
                    text = "";
                    timerOne = timerOne % timerOneMs;
                }

                timerTwo += diffMs;
                if (timerTwo > timerTwoMs) {
                    randomChar = String.fromCharCode(Math.round(String(' ').charCodeAt(0) + Math.random()*26)) + '';
                    timerTwo = timerTwo % timerTwoMs;
                }
            }

            // ------------------------------------

            var demo = -1;

            function engineTimeLapse(sinceStartMs)
            {
                diffMs = sinceStartMs - sinceStartMsPrev;
                sinceStartMsPrev = sinceStartMs;

                if (demo === -1) {
                    demo = randomInt(0, 3);
                }
                demo = 3;
                switch (demo) {
                    case 0:
                        demo0();
                        break;
                    case 1:
                        demo1();
                        break;
                    case 2:
                        demo2();
                        break;
                    case 3:
                        demo3();
                        break;
                }
            }

            function randomInt(min, max) 
            {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
        
            function round(x)
            {
                return Math.round(x);
            }

            function sinMul(m, x)
            {
                return m * Math.sin(2 * Math.PI * x);
            }

            // ------------------------------

            function init()
            {
                kbInit();
                fbInit(128, 64);
            }

            function loop()
            {
                var sinceStartMs;

                driverKeyboardUpdate();
                sinceStartMs = driverTimerGetSinceStartMs();
                engineTimeLapse(sinceStartMs);
                driverScreenUpdate();
            }

        </script>

        <style>
            body, html { overflow: hidden; width: 100%; height: 100%; display: block; border: none; outline: 0; margin: 0; padding: 0; }
            #c { display: block; border: none; outline: 0; margin: 0; padding: 0; position: relative; z-index: 9; }
            #fps { display: block; width: 50px; height: 50px; position: fixed; top: 10px; left: 10px; z-index: 10; color: black; font-family: Arial; font-weight: bold; font-size: 25px; line-height: 1em; }
        </style>
    </head>

    <body onLoad="appRun()" onResize="appResize()">
        <canvas id="c"></canvas>
        <div id="fps"></div>
    </body>
</html>