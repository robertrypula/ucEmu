<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
    </head>
    <body>

        <div>Sample</div>
        <canvas width="3000" height="128" id="buffer-sample" style="border: 1px solid red;"></canvas>
        <div>Power [dB]</div>
        <canvas width="3000" height="128" id="buffer-power" style="border: 1px solid green;"></canvas>
        <div>Phase</div>
        <canvas width="3000" height="128" id="buffer-phase" style="border: 1px solid green;"></canvas>

        <div>Constellation</div>
        <canvas width="512" height="512" id="constellation-diagram" style="border: 1px solid green;"></canvas>


        <input type="number" id="samples-per-period" onChange="onSamplesPerPeriodChange(this)" value="7000" />



        <script src="audio-util/audio-util.js"></script>
        <script src="carrier-recovery/carrier-recovery.factory.js"></script>
        <script src="carrier-generate/carrier-generate.factory.js"></script>

        <script>

            var
                sampleFrequency = 44100,
                brustDuration = sampleFrequency * 0.040,  // 1764 samples per brust, 25 baud / sec
                color = 1 ? 'rgba(130, 90, 200, 1)' : 'rgba(250, 250, 250, 1)',
                sampleMax = 3000,
                bufferSample = [],
                bufferPower = [],
                bufferPhase = [],
                samplesPerPeriod = [
                    sampleFrequency / (7000 + 0),
                    sampleFrequency / (7000 + 100),
                    sampleFrequency / (7000 + 200)
                ];
                carrierRecovery = new CarrierRecovery(samplesPerPeriod[0], brustDuration),
                carrierGenerate = [];
                data = [
                    [
                        { amplitude: +0.00, duration: 100, phase: +0.000 },
                        { amplitude: +0.30, duration: brustDuration, phase: +0.125 + 0.000 },
                        { amplitude: +0.00, duration: 200, phase: +0.000 }
                    ],
                    [
                        { amplitude: +0.00, duration: 100, phase: +0.000 },
                        { amplitude: +0.30, duration: brustDuration, phase: +0.125 + 0.250 },
                        { amplitude: +0.00, duration: 200, phase: +0.000 }
                    ],
                    [
                        { amplitude: +0.00, duration: 100, phase: +0.000 },
                        { amplitude: +0.30, duration: brustDuration, phase: +0.125 + 0.500 },
                        { amplitude: +0.00, duration: 200, phase: +0.000 }
                    ]
                ]
            ;

            function onSamplesPerPeriodChange(input) {
                carrierRecovery.setSamplePerPeriod(sampleFrequency / parseFloat(input.value));
                nextFrame();
            }

            function addNoise(buffer, amount) {
                var i;

                for (i = 0; i < buffer.length; i++) {
                    buffer[i] += ((Math.random() * 2) - 1.0) * amount;
                }
            }

            function draw(canvasId, buffer) {
                var i;
                var canvas = document.getElementById(canvasId);
                var ctx = canvas.getContext("2d");
                var offsetY;

                ctx.lineWidth = 1;
                ctx.strokeStyle = color;
                ctx.clearRect(0, 0, 3000, 128);
                for (i = 0; i < buffer.length; i++) {
                    offsetY = Math.round(buffer[i] * 64);
                    ctx.beginPath();
                    ctx.moveTo(i, 64);
                    ctx.lineTo(i, 64 - (offsetY === 0 ? 1 : offsetY));
                    ctx.closePath();
                    ctx.stroke();
                }
            }

            function drawConstellationDiagram(canvasId, bufferPhase, bufferPower) {
                var i;
                var canvas = document.getElementById(canvasId);
                var ctx = canvas.getContext("2d");
                var x, y;

                ctx.fillStyle = color;

                ctx.lineWidth = 1;
                ctx.strokeStyle = color;
                ctx.clearRect(0, 0, 512, 512);
                ctx.beginPath();
                ctx.moveTo(0, 256);
                ctx.lineTo(512, 256);
                ctx.closePath();
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(256, 0);
                ctx.lineTo(256, 512);
                ctx.closePath();
                ctx.stroke();
                for (i = 0; i < bufferPhase.length; i++) {
                    if (i < (100 + brustDuration) - 50 || i > (100 + brustDuration) + 50) {
                        continue;
                    }
                    x = 256 + 256 * bufferPower[i] * Math.cos(2 * Math.PI * bufferPhase[i]);
                    y = 256 - 256 * bufferPower[i] * Math.sin(2 * Math.PI * bufferPhase[i]);
                    ctx.fillRect(x - 1, y - 1, 3, 3);
                }
            }

            function analyzeBufferSample(bufferSample, bufferPower, bufferPhase) {
                var i, carrierSample, powerNormalized;

                for (i = 0; i < bufferSample.length; i++) {
                    carrierRecovery.handleSample(bufferSample[i]);
                    carrierSample = carrierRecovery.getCarrier();

                    if (0) {
                        powerNormalized = carrierSample.power;
                    } else {
                        powerNormalized = (carrierSample.powerDecibel + 20) / 20;
                        powerNormalized = powerNormalized < 0 ? 0 : powerNormalized;
                    }

                    bufferPower.push(powerNormalized);
                    bufferPhase.push(carrierSample.phase);
                }
            }

            function nextFrame() {
                var i, sampleNumber, sample;

                carrierGenerate.length = 0;
                bufferSample.length = 0;
                bufferPower.length = 0;
                bufferPhase.length = 0;

                // create carrier generators and add data to queue
                for (i = 0; i < samplesPerPeriod.length; i++) {
                    carrierGenerate.push(
                        new CarrierGenerate(samplesPerPeriod[i], 50)
                    );
                    carrierGenerate[i].addToQueue(data[i]);
                }

                // fill sample buffer
                for (sampleNumber = 0; sampleNumber < sampleMax; sampleNumber++) {
                    sample = 0;
                    for (i = 0; i < samplesPerPeriod.length; i++) {
                        sample += carrierGenerate[i].getSample();
                        carrierGenerate[i].nextSample();
                    }
                    bufferSample[sampleNumber] = sample;
                }
                
                

                // ----
                addNoise(bufferSample, 0.2);
                analyzeBufferSample(bufferSample, bufferPower, bufferPhase);
                draw('buffer-sample', bufferSample);
                draw('buffer-power', bufferPower);
                draw('buffer-phase', bufferPhase);
                drawConstellationDiagram('constellation-diagram', bufferPhase, bufferPower);
            }


            function initialize() {
                nextFrame();
            }


            initialize();
            

            // --------------


            var cg = new CarrierGenerate(40, 5);

            function testCarrierGenerate(size) {
                var sample, i;

                for (i = 0; i < size; i++) {
                    sample = cg.getSample();
                    cg.nextSample();
                    console.log(sample); 
                    console.log(" ----");
                }                
            }

            testCarrierGenerate(2);

            cg.addToQueue([
                { duration: 8, amplitude: 0.5, phase: 0.0 }
            ]);

            testCarrierGenerate(10);

            cg.addToQueue([
                { duration: 4, amplitude: 0.5, phase: 0.0 }
            ]);

            testCarrierGenerate(5);

        </script>
    </body>
</html>